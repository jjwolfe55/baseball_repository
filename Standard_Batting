CREATE TABLE standard_batting (
player_id VARCHAR(9),
player_name VARCHAR(45),
team_id VARCHAR(3),
season_id SMALLINT,
bat CHAR(1),
primary_pos VARCHAR(3),
b_g SMALLINT,
b_pa SMALLINT,
b_ab SMALLINT,
b_r SMALLINT,
b_h SMALLINT,
b_s SMALLINT,
b_d SMALLINT,
b_t SMALLINT,
b_hr SMALLINT,
b_rbi SMALLINT,
b_sh SMALLINT,
b_sf SMALLINT,
b_hbp SMALLINT,
b_bb SMALLINT,
b_ibb SMALLINT,
b_so SMALLINT,
b_sb SMALLINT,
b_cs SMALLINT,
b_gdp SMALLINT,
b_ci SMALLINT,
b_roe SMALLINT,
PRIMARY KEY (player_id,team_id,season_id)
);

INSERT INTO standard_batting (
player_id,
player_name,
team_id,
season_id,
bat,
primary_pos,
b_g,
b_pa,
b_ab,
b_r,
b_h,
b_s,
b_d,
b_t,
b_hr,
b_rbi,
b_sh,
b_sf,
b_hbp,
b_bb,
b_ibb,
b_so,
b_sb,
b_cs,
b_gdp,
b_ci,
b_roe
)
SELECT DISTINCT(a.player_id) AS player_id,
 CONCAT(b.first_name,' ',b.last_name) AS player_name,
 a.team_id AS team_id, 
 SUBSTRING(a.game_date,1,4) AS season_id,
 b.bat AS bat,
 b.primary_pos AS primary_pos,
 c.b_g AS b_g, 
 c.b_pa AS b_pa,
 c.b_ab AS b_ab,
 c.b_r AS b_r,
 c.b_h AS b_h,
 c.b_s AS b_s,
 c.b_d AS b_d,
 c.b_t AS b_t,
 c.b_hr AS b_hr,
 c.b_rbi AS b_rbi,
 c.b_sh AS b_sh,
 c.b_sf AS b_sf,
 c.b_hbp AS b_hbp,
 c.b_bb AS b_bb,
 c.b_ibb AS b_ibb,
 c.b_so AS b_so,
 c.b_sb AS b_sb,
 c.b_cs AS b_cs,
 c.b_gdp AS b_gdp,
 c.b_ci AS b_ci,
 c.b_roe AS b_roe
FROM lines_batting AS a
LEFT JOIN lines_rosters AS b
ON a.player_id = b.player_id
INNER JOIN 
(SELECT DISTINCT(a.player_id) AS player_id,
a.team_id AS team_id,
a.game_id AS game_id,
SUBSTRING(a.game_date,1,4) AS season_id,
COUNT(a.player_id) AS b_g,
SUM(a.b_pa) AS b_pa,
SUM(a.b_ab) AS b_ab,
SUM(a.b_r) AS b_r,
SUM(a.b_h) AS b_h,
SUM(a.b_h)-(SUM(a.b_d)+SUM(a.b_t)+SUM(a.b_hr)) AS b_s,
SUM(a.b_d) AS b_d,
SUM(a.b_t) AS b_t,
SUM(a.b_hr) AS b_hr,
SUM(a.b_rbi) AS b_rbi,
SUM(a.b_sh) AS b_sh,
SUM(a.b_sf) AS b_sf,
SUM(a.b_hbp) AS b_hbp,
SUM(a.b_bb) AS b_bb,
SUM(a.b_ibb) AS b_ibb,
SUM(a.b_so) AS b_so,
SUM(a.b_sb) AS b_sb,
SUM(a.b_cs) AS b_cs,
SUM(a.b_gdp) AS b_gdp,
SUM(a.b_ci) AS b_ci,
SUM(a.b_roe) AS b_roe
FROM lines_batting AS a
WHERE a.integrity = 'Value' AND a.game_type = 'regular' 
GROUP BY a.player_id,a.team_id,SUBSTRING(a.game_date,1,4)) AS c
ON a.player_id = c.player_id  AND a.team_id = c.team_id AND a.game_id = c.game_id
WHERE a.integrity = 'Value' AND a.game_type = 'regular' 
GROUP BY a.player_id,a.team_id,SUBSTRING(a.game_date,1,4);
